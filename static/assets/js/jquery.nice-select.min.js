(function ($) {
    $.fn.niceSelect = function (method) {
        let timeout;

        function initDropdown(element) {
            element.after(
                $('<div></div>')
                    .addClass('nice-select')
                    .addClass(element.attr('class') || '')
                    .addClass(element.attr('disabled') ? 'disabled' : '')
                    .attr('tabindex', element.attr('disabled') ? null : '0')
                    .html('<span class="current"></span><ul class="list"></ul>')
            );
            var select = element.next(),
                options = element.find('option'),
                selectedOption = element.find('option:selected');
            select.find('.current').html(selectedOption.data('display') || selectedOption.text());
            options.each(function () {
                var option = $(this),
                    display = option.data('display'),
                    submenuData = option.data('submenu'); // Add submenu data if any
                let optionHtml = $('<li></li>')
                    .attr('data-value', option.val())
                    .attr('data-display', display || null)
                    .addClass(
                        'option' +
                        (option.is(':selected') ? ' selected' : '') +
                        (option.is(':disabled') ? ' disabled' : '')
                    )
                    .html(option.text());

                // Add a submenu container if submenu data exists
                if (submenuData) {
                    const submenu = $('<ul></ul>')
                        .addClass('submenu')
                        .html(
                            submenuData
                                .split(',') // Assuming submenu items are comma-separated
                                .map((item) => `<li class="submenu-item">${item}</li>`)
                                .join('')
                        );
                    optionHtml.append(submenu);
                }

                select.find('ul').append(optionHtml);
            });

            // Add the search box to the top of the dropdown list
            var searchBox = '<input type="text" class="nice-select-search" style="display: none;">'; // Initially hidden
            select.find('.list').before(searchBox);
        }

        if (typeof method === 'string') {
            if (method === 'update') {
                return this.each(function () {
                    var element = $(this),
                        select = element.next('.nice-select'),
                        isOpen = select.hasClass('open');
                    if (select.length) {
                        select.remove();
                        initDropdown(element);
                        if (isOpen) {
                            element.next().trigger('click');
                        }
                    }
                });
            } else if (method === 'destroy') {
                return this.each(function () {
                    var element = $(this),
                        select = element.next('.nice-select');
                    if (select.length) {
                        select.remove();
                        element.css('display', '');
                    }
                });
            } else {
                console.log('Method "' + method + '" does not exist.');
            }
            return this;
        }

        this.hide();
        this.each(function () {
            var element = $(this);
            if (!element.next().hasClass('nice-select')) {
                initDropdown(element);
            }
        });

        $(document).off('.nice_select');

        // Toggle search box visibility on dropdown click
        $(document).on('click.nice_select', '.nice-select', function () {
            var dropdown = $(this);
            if (!dropdown.hasClass('disabled')) {
                clearTimeout(timeout);
                $('.nice-select').not(dropdown).removeClass('open');
                dropdown.toggleClass('open');

                // Show search box only if the dropdown is opened
                if (dropdown.hasClass('open')) {
                    dropdown.find('.nice-select-search').show().focus();
                    dropdown.find('.current').hide(); // Hide the current text
                } else {
                    dropdown.find('.nice-select-search').hide();
                    dropdown.find('.current').show(); // Show the current text
                }
            }
        });

        // Close the dropdown on mouse leave with a fade-out delay
        $(document).on('mouseleave.nice_select', '.nice-select', function (event) {
            var dropdown = $(this);
            var relatedTarget = $(event.relatedTarget);

            // Check if the mouse is moving to the cities dropdown
            if (!relatedTarget.closest('.cities-dropdown').length) {
                timeout = setTimeout(function () {
                    dropdown.removeClass('open');
                    dropdown.find('.nice-select-search').hide(); // Hide search box on close
                    dropdown.find('.current').show(); // Show the current text
                }, 300);
            }
        });

        // Close the dropdown if clicked outside
        $(document).on('click.nice_select', function (event) {
            if ($(event.target).closest('.nice-select').length === 0) {
                $('.nice-select').removeClass('open').find('.nice-select-search').hide(); // Hide search box on close
                $('.nice-select').find('.current').show(); // Show the current text
            }
        });

        // Show submenu on hover
        $(document).on('mouseenter', '.nice-select .option', function () {
            $(this).find('.submenu').stop(true, true).fadeIn(200);
        });

        // Hide submenu on mouse leave
        $(document).on('mouseleave', '.nice-select .option', function () {
            $(this).find('.submenu').stop(true, true).fadeOut(200);
        });

        // Option click to select and keep regions open
        $(document).on('mouseenter.nice_select', '.nice-select .option:not(.disabled)', function () {
            var option = $(this),
                select = option.closest('.nice-select');
            select.find('.selected').removeClass('selected');
            option.addClass('selected');
            var display = option.data('display') || option.text();
            select.find('.current').text(display);
            select.prev('select').val(option.data('value')).trigger('change');

            // Close the dropdown only if a city is selected
            if (select.hasClass('cities')) {
                select.removeClass('open'); // Close if it's a city selection
            } else {
                // Keep the dropdown open if it's a region selection
                select.addClass('open');
            }
        });

        // Handle submenu item click
        $(document).on('click', '.nice-select .submenu-item', function (event) {
            event.stopPropagation(); // Prevent the click from bubbling up to the parent option
            var submenuItem = $(this);
            var parentOption = submenuItem.closest('.option');
            var select = parentOption.closest('.nice-select');
            var display = submenuItem.text();

            // Update the current display text with the submenu item text
            select.find('.current').text(display);
            select.prev('select').val(parentOption.data('value')).trigger('change');

            // Keep the dropdown open after selecting a submenu item
            select.addClass('open');
        });

        // Search functionality
        $(document).on('keyup.nice_select', '.nice-select-search', function () {
            var searchTerm = $(this).val().toLowerCase();
            var listItems = $(this).next('.list').find('.option');
            listItems.each(function () {
                var optionText = $(this).text().toLowerCase();
                if (optionText.indexOf(searchTerm) === -1) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });

        return this;
    };
})(jQuery);